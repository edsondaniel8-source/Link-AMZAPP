<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Seguro - Firebase Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .security-notice {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .auth-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9f9f9;
            margin: 20px 0;
        }
        
        .upload-btn, .auth-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .upload-btn:hover, .auth-btn:hover {
            background: #45a049;
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .logout-btn {
            background: #f44336;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .user-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Upload Seguro de Documentos</h1>
        
        <div class="security-notice">
            <h3>üõ°Ô∏è Sistema Seguro</h3>
            <p><strong>‚úÖ Autentica√ß√£o obrigat√≥ria</strong> - Apenas usu√°rios logados podem fazer upload</p>
            <p><strong>‚úÖ Arquivos privados</strong> - Cada usu√°rio acessa apenas seus pr√≥prios arquivos</p>
            <p><strong>‚úÖ API Key p√∫blica segura</strong> - Protegida por Firebase Rules</p>
        </div>

        <!-- Se√ß√£o de Login -->
        <div class="auth-section" id="loginSection">
            <h3>üîê Autentica√ß√£o Necess√°ria</h3>
            <p>Fa√ßa login com Google para enviar documentos de forma segura:</p>
            <button class="auth-btn" id="loginBtn">üîë Login com Google</button>
        </div>

        <!-- Informa√ß√µes do usu√°rio logado -->
        <div class="user-info hidden" id="userInfo">
            <p>üë§ <strong>Logado como:</strong> <span id="userName"></span></p>
            <p>üìß <strong>Email:</strong> <span id="userEmail"></span></p>
            <button class="auth-btn logout-btn" id="logoutBtn">üö™ Logout</button>
        </div>
        
        <!-- √Årea de Upload (s√≥ aparece se logado) -->
        <div class="upload-area hidden" id="uploadArea">
            <p>üì∑ Selecione uma foto do seu BI, Passaporte ou Carta de Condu√ß√£o</p>
            
            <!-- Input file escondido -->
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            
            <!-- Bot√£o vis√≠vel -->
            <button class="upload-btn" id="selectBtn">Selecionar Foto</button>
        </div>
        
        <!-- Barra de progresso -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Preparando upload...</div>
        </div>
        
        <!-- Status messages -->
        <div class="status" id="statusMessage"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // ‚úÖ CONFIGURA√á√ÉO SEGURA DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAA_oMM-YkGXCJGI8l2HQHJkAk1nG7SfNs", // ‚úÖ API Key p√∫blica segura
            authDomain: "link-a-turismo-mozambique.firebaseapp.com",
            projectId: "link-a-turismo-mozambique",
            storageBucket: "link-a-turismo-mozambique.firebasestorage.app",
            messagingSenderId: "1058402037541",
            appId: "1:1058402037541:web:9ca4e189a375426e3b34cc"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // Elementos do DOM
        const loginSection = document.getElementById('loginSection');
        const userInfo = document.getElementById('userInfo');
        const uploadArea = document.getElementById('uploadArea');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusMessage = document.getElementById('statusMessage');

        let currentUser = null;

        // Fun√ß√£o para mostrar status
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.style.display = 'block';
        }

        // Fun√ß√£o para esconder status
        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        // Fun√ß√£o para mostrar progresso
        function showProgress() {
            progressContainer.style.display = 'block';
        }

        // Fun√ß√£o para esconder progresso
        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // Gerenciar estado da UI baseado na autentica√ß√£o
        function updateUI(user) {
            if (user) {
                console.log('‚úÖ Usu√°rio autenticado:', user.displayName);
                
                // Mostrar info do usu√°rio
                userName.textContent = user.displayName || 'Usu√°rio';
                userEmail.textContent = user.email;
                
                // Mostrar/esconder se√ß√µes
                loginSection.classList.add('hidden');
                userInfo.classList.remove('hidden');
                uploadArea.classList.remove('hidden');
                
                currentUser = user;
            } else {
                console.log('‚ùå Usu√°rio n√£o autenticado');
                
                // Esconder se√ß√µes autenticadas
                loginSection.classList.remove('hidden');
                userInfo.classList.add('hidden');
                uploadArea.classList.add('hidden');
                hideProgress();
                hideStatus();
                
                currentUser = null;
            }
        }

        // Monitorar estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            updateUI(user);
        });

        // Login com Google
        loginBtn.addEventListener('click', async () => {
            try {
                console.log('üîë Iniciando login...');
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log('‚úÖ Login realizado:', user.displayName);
                showStatus(`‚úÖ Login realizado como ${user.displayName}!`, 'success');
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                showStatus('‚ùå Erro no login. Tente novamente.', 'error');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('üëã Logout realizado');
                showStatus('üëã Logout realizado com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro no logout:', error);
            }
        });

        // Bot√£o "Selecionar Foto" clica no input escondido
        selectBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                showStatus('‚ùå Fa√ßa login primeiro!', 'error');
                return;
            }
            
            console.log('üî• BOT√ÉO CLICADO!');
            hideStatus();
            
            // Clica no input file escondido
            fileInput.click();
            console.log('‚úÖ Input file acionado!');
        });

        // Quando usu√°rio seleciona um arquivo
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            
            if (!file) {
                console.log('‚ùå Nenhum arquivo selecionado');
                return;
            }
            
            if (!currentUser) {
                showStatus('‚ùå Erro: usu√°rio n√£o autenticado', 'error');
                return;
            }
            
            console.log('üìÅ Arquivo selecionado:', file.name);
            console.log('üìè Tamanho:', (file.size / 1024 / 1024).toFixed(2) + ' MB');
            console.log('üé≠ Tipo:', file.type);
            console.log('üë§ Usu√°rio:', currentUser.uid);
            
            // Validar se √© uma imagem
            if (!file.type.startsWith('image/')) {
                showStatus('‚ùå Por favor, selecione apenas arquivos de imagem!', 'error');
                return;
            }
            
            // Fazer upload do arquivo
            uploadFile(file);
        });

        // üîí Fun√ß√£o para fazer upload SEGURO
        function uploadFile(file) {
            if (!currentUser) {
                showStatus('‚ùå Usu√°rio n√£o autenticado', 'error');
                return;
            }

            hideStatus();
            showProgress();
            
            // Gerar nome √∫nico para o arquivo
            const timestamp = new Date().getTime();
            const fileName = `${timestamp}_${file.name}`;
            
            console.log('üöÄ Iniciando upload seguro para:', fileName);
            console.log('üîí Pasta do usu√°rio:', currentUser.uid);
            
            // üîí UPLOAD SEGURO: pasta espec√≠fica do usu√°rio
            const storageRef = ref(storage, `documentos/${currentUser.uid}/${fileName}`);
            
            // Criar upload task
            const uploadTask = uploadBytesResumable(storageRef, file);
            
            // Desabilitar bot√£o durante upload
            selectBtn.disabled = true;
            selectBtn.textContent = 'Enviando...';
            
            // Monitorar progresso do upload
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Calcular progresso
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    
                    console.log(`üìä Progresso: ${progress.toFixed(2)}%`);
                    console.log(`üì§ Enviado: ${(snapshot.bytesTransferred / 1024 / 1024).toFixed(2)} MB`);
                    console.log(`üì¶ Total: ${(snapshot.totalBytes / 1024 / 1024).toFixed(2)} MB`);
                    
                    // Atualizar barra de progresso
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Enviando... ${Math.round(progress)}%`;
                },
                (error) => {
                    // Erro durante upload
                    console.error('‚ùå Erro no upload:', error);
                    console.error('C√≥digo do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    
                    hideProgress();
                    
                    // Mensagem de erro espec√≠fica
                    let errorMessage = '‚ùå Erro ao enviar arquivo. ';
                    if (error.code === 'storage/unauthorized') {
                        errorMessage += 'Usu√°rio n√£o autorizado. Configure as Firebase Rules!';
                    } else {
                        errorMessage += 'Tente novamente.';
                    }
                    
                    showStatus(errorMessage, 'error');
                    
                    // Reabilitar bot√£o
                    selectBtn.disabled = false;
                    selectBtn.textContent = 'Selecionar Foto';
                },
                () => {
                    // Upload conclu√≠do com sucesso
                    console.log('‚úÖ Upload seguro conclu√≠do!');
                    
                    // Obter URL de download
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        console.log('üîó Link de download:', downloadURL);
                        console.log('üìÅ Nome do arquivo:', fileName);
                        console.log('üìÇ Pasta segura:', `documentos/${currentUser.uid}/`);
                        console.log('üë§ Propriet√°rio:', currentUser.displayName);
                        
                        // Esconder progresso
                        hideProgress();
                        
                        // Mostrar sucesso
                        showStatus('‚úÖ Foto enviada com sucesso!', 'success');
                        
                        // Alert de sucesso
                        alert('Foto enviada com sucesso!');
                        
                        // Reabilitar bot√£o
                        selectBtn.disabled = false;
                        selectBtn.textContent = 'Selecionar Foto';
                        
                        // Limpar input
                        fileInput.value = '';
                        
                        console.log('üéâ UPLOAD SEGURO CONCLU√çDO!');
                    });
                }
            );
        }

        console.log('üîí Sistema seguro inicializado!');
        console.log('üìã Funcionalidades:');
        console.log('‚úÖ Autentica√ß√£o Google obrigat√≥ria');
        console.log('‚úÖ Upload em pasta espec√≠fica do usu√°rio');
        console.log('‚úÖ API Key p√∫blica protegida por Firebase Rules');
        console.log('‚úÖ Arquivos privados por usu√°rio');
    </script>
</body>
</html>